""" TODO
* Mark start(green) and top (red). Holds blue
* save
    * login
    * register
* load
* Dont call update_flask() for every callup. Either at startup (name==main) or through some kind of admin panel
"""

from flask import Flask, render_template, url_for, redirect, flash, request, session, jsonify
from flask_pymongo import PyMongo
from find_rects import update_flask
from passlib.hash import sha256_crypt
from functions import login_required, Rectangles
from SECRETS import *

app = Flask(__name__)
app.config["SECRET_KEY"] = SECRET
app.config["MONGO_URI"] = MDB_URI
db = PyMongo(app).db

@app.route('/')
def index():
    return render_template("new.html", coords=coords, width=3000, height=4000, scale=0.22)


@app.route('/route/<string:name>')
def route(name):
   route = db.routes.find_one({"name": name})
   return render_template("route.html", route=route, width=3000, height=4000, scale=0.22)


@app.route('/myroutes/')
# @login_required
def myroutes():
   pass


@app.route('/all/')
def all():
    routes = db.routes.find({})
    return render_template("all.html", routes=routes)


@app.route('/search/')
def search():
   pass


@app.route('/new/')
# @login_required
def new():
    return render_template("new.html", coords=coords, width=3000, height=4000, scale=0.22, buttons=["save"])


@app.route('/save/', methods=["POST"])
def save():
    if request.method == "POST":
        req = request.get_json()

        if db.routes.count_documents({"name": req["name"]}) == 0:
            name = req["name"]
            difficulty = req["difficulty"]
            canvasData = req["canvasData"]
            author = session["username"]

            insert_res = db.routes.insert_one({"name": name, "difficulty": difficulty, "canvasData": canvasData})

            return redirect(url_for("index")) #CHANGE TO ROUTE DISPLAY

        else:
            flash("Diesen Namen gibt es bereits")
    else:
        return redirect(url_for("index"))


@app.route('/edit/')
# @login_required
def edit():
   pass


@app.route('/delete/')
def delete():
   pass


@app.route('/profile/')
# @login_required
def profile():
   pass


@app.route('/admin/')
# @login_required
def admin():
   pass


@app.route('/login/', methods=["POST", "GET"])
def login():
    if request.method == "POST":
        user = request.form['username']
        password = request.form['password']

        userObj = db.users.find_one({"$or": [{"username": user}, {"email": user}]})

        if userObj is not None:
            # password check. Use sha256_crypt
            if sha256_crypt.verify(password, userObj["password"]):
                session['logged_in'] = True
                session['username'] = userObj["username"]
                session['admin'] = userObj['status']['admin']
                print(session['admin'])
                return redirect(url_for("index"))

            else:
                flash("Ungültiger Username oder Passwort")

        else:
            flash("Ungültiger Username oder Passwort")

    return render_template("login.html")


@app.route('/register/', methods=['POST', 'GET'])
def register():
    if request.method == "POST":
        if db.users.count_documents({"username": request.form["username"]}) == 0 and db.users.count_documents({"email": request.form["email"]}) == 0:
            user = {
                "username": request.form["username"],
                "email": request.form["email"],
                "password": sha256_crypt.hash(request.form["password"]),
                "settings": {},
                "status": {"admin": "False"},
            }

            insert_res = db.users.insert_one(user)
            return redirect(url_for('index'))

        else:
            flash("Username oder Email gibt es bereits")

    return render_template("register.html")


@app.route('/logout/')
@login_required
def logout():
   session.clear()
   flash("Erfolgreich ausgeloggt")
   return redirect(url_for("index"))


if __name__ == '__main__':
    #coords = Rectangles().coordinates
    coords = [[2645, 3437, 2699, 3486], [1172, 3422, 1224, 3471], [1657, 3419, 1724, 3477], [1533, 3419, 1598, 3471], [2141, 3418, 2209, 3483], [321, 3412, 380, 3459], [2841, 3388, 2889, 3436], [551, 3388, 645, 3472], [2461, 3374,
2514, 3430], [1476, 3360, 1532, 3410], [736, 3350, 808, 3407], [1937, 3348, 2057, 3441], [1287, 3301, 1351, 3352], [310, 3287, 386, 3352], [2194, 3272, 2307, 3333], [2090, 3239, 2152, 3306], [129, 3239, 188, 3295], [2786, 3207, 2841, 3259], [1536, 3194, 1590, 3240], [1041, 3187, 1100, 3254], [793, 3185, 864, 3246], [2274, 3183, 2344, 3253], [547, 3180, 620, 3237], [52, 3178, 116, 3240], [908, 3176, 993, 3244], [1760, 3174, 1855, 3254], [402, 3153, 473, 3211], [2580, 3149, 2663, 3210], [1955, 3129, 2035, 3196], [1283, 3068, 1345, 3122], [918, 3064, 984, 3120], [1708, 3063, 1762, 3108], [304, 3058, 362, 3129], [543, 3056, 622, 3126], [2477, 3019, 2534, 3077], [1098, 3018, 1159, 3061], [1956, 3011, 2044, 3086], [731, 3006, 793, 3062], [2824, 3005, 2942, 3099], [1660, 2954, 1714, 3011], [2126, 2952, 2229, 3044], [1522, 2940, 1615, 3027], [2257, 2939, 2365, 3028],
[108, 2894, 163, 2945], [847, 2891, 912, 2954], [1963, 2886, 2043, 2973], [1207, 2886, 1303, 2955], [1336, 2877, 1425, 2962], [722, 2877, 801, 2952], [211, 2877, 297, 2954], [372, 2868, 460, 2918], [587, 2857, 697, 2970], [2574, 2855, 2707, 3006], [2090, 2794, 2132, 2829], [1596, 2780, 1657, 2831], [1711, 2760, 1805, 2847], [847, 2760, 918, 2831], [1200, 2758, 1306, 2848], [2289, 2723, 2354, 2780], [2156, 2722, 2233, 2787], [384, 2708, 468, 2780], [524, 2707, 597, 2770], [1861, 2703, 2017, 2806], [660, 2700, 729, 2770], [945, 2667, 1084, 2872], [2774, 2661, 2937, 2826], [1333, 2658, 1405, 2721], [1437, 2651, 1505, 2698], [1591, 2649, 1657, 2707], [821, 2634, 920, 2719], [2286, 2588, 2369, 2660], [638, 2582, 721, 2648], [843, 2531, 893, 2587], [942, 2527, 1055, 2604], [2604, 2524, 2710, 2620], [1457, 2516, 1539, 2591], [1583, 2511, 1664, 2610], [297, 2509, 416, 2605], [182, 2503, 274, 2583], [2459, 2500, 2589, 2623], [746, 2498, 821, 2544], [2831, 2477, 2875, 2528], [2356, 2408, 2451, 2491], [1601, 2406, 1687, 2469], [1082, 2406, 1155, 2462], [319, 2402, 402, 2466], [963, 2401, 1029, 2466], [2080, 2400, 2181, 2476], [1427, 2374, 1509, 2421], [2593, 2373, 2706, 2494], [2241, 2364, 2350, 2520], [96, 2330, 219, 2426], [1594, 2320, 1676, 2375], [2804, 2301, 2940, 2431], [738, 2301, 841, 2466], [1966, 2297, 2061, 2355], [1090, 2282, 1149, 2347], [564, 2277, 644, 2351], [952, 2275, 1045, 2350], [1208, 2272, 1287, 2360], [440, 2268, 521, 2355], [1600, 2254, 1653, 2305], [2839, 2217, 2906, 2276], [979, 2181, 1060, 2243], [1313, 2155, 1379, 2216], [1590, 2154, 1664, 2226], [463, 2151, 530, 2221], [1201, 2144, 1260, 2195], [2377, 2142, 2470, 2213], [2117, 2141, 2191, 2224], [2628, 2138, 2730, 2227], [807, 2137, 909, 2237], [534, 2135, 660, 2236], [679, 2131, 789, 2248], [2228, 2110, 2322, 2258], [1794, 2095, 1938, 2229], [268, 2095, 408, 2250], [1403, 2091, 1484, 2161], [548, 2029, 627, 2092], [1602, 2026, 1662, 2084], [2866, 2022, 2965, 2108], [2356, 2012, 2468, 2095], [2529, 1986, 2624, 2088], [1023, 1983, 1150, 2119], [926, 1977, 1001, 2096], [358, 1956, 444, 2030], [2692, 1952, 2800, 2041], [76, 1947, 196, 2050], [720, 1938, 842, 2059], [2138, 1926, 2303, 2060], [1454, 1897, 1532, 1965], [1969, 1890, 2076, 1970], [2341, 1888, 2455, 1941], [195, 1824, 302, 1909], [382, 1798, 443, 1871], [1299, 1790, 1370, 1890], [1601, 1778, 1659, 1829], [1836, 1775, 1936, 1839],
[2254, 1765, 2320, 1844], [553, 1765, 615, 1835], [1442, 1743, 1536, 1845], [2622, 1730, 2779, 1858], [2082, 1724, 2219, 1859], [1002, 1704, 1077, 1767], [761, 1692, 928, 1886], [1626, 1676, 1735, 1763], [1960, 1671, 2035, 1769], [1768, 1667, 1896, 1765], [941, 1637, 1002, 1688], [1166, 1624, 1314, 1725], [2769, 1621, 2888, 1720], [356, 1602, 529, 1748], [867, 1562, 934, 1643], [575, 1557, 701, 1636], [183, 1551, 318, 1677], [2598,
1550, 2679, 1632], [709, 1547, 818, 1642], [1736, 1500, 1818, 1590], [1568, 1495, 1684, 1599], [1985, 1489, 2074, 1599], [903, 1461, 983, 1526], [2089, 1448, 2227, 1651], [437, 1430, 577, 1521], [1124, 1427, 1194, 1492], [710, 1423, 820, 1508], [608, 1406, 703, 1483], [2704, 1384, 2855, 1525], [2478, 1372, 2577, 1440], [1722, 1349, 1811, 1432], [875, 1348, 960, 1397], [2255, 1347, 2344, 1425], [1853, 1343, 1952, 1432], [188, 1288, 385, 1484], [2192, 1243, 2302, 1310], [2002, 1226, 2082, 1308], [518, 1215, 596, 1290], [641, 1208, 728, 1273], [2656, 1205, 2784, 1302], [437, 1168, 510, 1231], [831, 1141, 984, 1256], [1146, 1137, 1218, 1196], [1778,
1122, 1901, 1266], [2444, 1109, 2617, 1283], [2322, 1104, 2433, 1267], [636, 1084, 725, 1157], [1572, 1076, 1683, 1175], [1979, 1068, 2104, 1196], [1079, 1019, 1160, 1120], [274, 1015, 377, 1111], [1686, 987, 1771, 1057], [2210, 974, 2292, 1099], [2547, 965, 2644, 1048], [1845, 931, 1977, 1039], [1164, 922, 1263, 1025], [918, 917, 999, 1051], [2051, 905, 2148, 973], [741, 905, 874, 1049], [1420, 897, 1576, 1048], [1287, 894, 1369, 961], [120, 849, 247, 963], [1738, 818, 1854, 912], [2213, 793, 2311, 857], [610, 771, 734, 882], [1055, 760, 1136, 825], [2518, 759, 2669, 936], [1498, 718, 1624, 813], [799, 717, 948, 809], [1916, 699, 2051, 835], [862, 492, 1003, 614], [1703, 485, 1856, 620], [38, 482, 174, 602], [2856, 465, 2970, 577], [430, 464, 592, 613], [2549, 460, 2694, 592], [1292, 460, 1424, 590], [1992, 453, 2122, 617], [2261, 438, 2423, 598], [972, 3260, 1206, 3436], [1366, 3030, 1563, 3174], [1006, 2932, 1131, 3016], [2806, 2884, 2953, 3011], [445, 2835, 589, 3004], [2351, 2694, 2572, 2866], [1703, 2641, 1818, 2762], [280, 2594, 330, 2644], [2164, 2590, 2242, 2660],
[751, 2587, 847, 2643], [1529, 2472, 1605, 2526], [2168, 2464, 2245, 2532], [426, 2433, 652, 2593], [838, 2406, 902, 2468], [1216, 2359, 1437, 2577], [2707, 2353, 2755, 2400], [2045, 2348, 2116, 2417], [638, 2348, 713, 2404], [1507, 2334, 1604, 2437], [2200, 2293, 2263, 2350], [2335, 2283, 2391, 2321], [1704, 2255, 1966, 2524], [4, 2242, 385, 2316], [2453, 2221, 2637, 2387], [2316, 2212, 2373, 2245], [2038, 2190, 2140, 2291], [1722, 2145, 1792, 2213], [1331, 2025, 1414, 2135], [1962, 2021, 2068, 2101], [1504, 1952, 1606, 2041], [1007, 1853, 1216, 1985], [471, 1838, 601, 1940], [1643, 1830, 1879, 2023], [2322, 1826, 2386, 1886], [2441, 1818, 2526, 1892], [1076, 1689, 1162, 1731], [2300, 1524, 2583, 1780], [1793, 1432, 1867, 1505], [1962, 1328, 2111, 1462], [1009, 1293, 1161, 1559], [1217, 1186, 1595, 1586], [1186, 1068, 1282, 1148], [410, 865, 626, 1065]]

    app.run(debug=True)